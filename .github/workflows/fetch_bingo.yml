name: fetch

on:
  schedule:
    # 每 5 分鐘跑一次（UTC）
    - cron: "*/5 * * * *"
  workflow_dispatch:
    inputs:
      OPEN_DATE:
        description: "指定抓取日期 (YYYY-MM-DD)，留空=今天(台北時區)"
        required: false
        default: ""
      FORCE:
        description: "true=無視時間門檻立刻跑"
        required: false
        default: "false"

permissions:
  contents: write

concurrency:
  group: fetch-bingo
  cancel-in-progress: false

jobs:
  fetch:
    runs-on: ubuntu-24.04
    env:
      OPEN_DATE: ${{ github.event.inputs.OPEN_DATE }}
      FORCE: ${{ github.event.inputs.FORCE }}

    steps:
      - name: Checkout (full)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install deps (if any)
        run: npm ci --no-audit --no-fund || true

      - name: Decide whether to run this minute (Taipei gating)
        id: gate
        shell: bash
        run: |
          force="${FORCE:-false}"
          if [[ "$force" == "true" ]]; then
            echo "run_this_minute=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # 今天才套時間門檻：07:05–23:55 的「+1 或 +2 分」
          TZ=Asia/Taipei hour=$(date +%H)
          TZ=Asia/Taipei minute=$(date +%M)
          hhmm="${hour}${minute}"
          in_window=false
          [[ "$hhmm" > "0704" && "$hhmm" < "2356" ]] && in_window=true

          mod=$((10#$minute % 5))
          on_edge=false
          [[ $mod -eq 1 || $mod -eq 2 ]] && on_edge=true

          if [[ "$in_window" == "true" && "$on_edge" == "true" ]]; then
            echo "run_this_minute=true" >> "$GITHUB_OUTPUT"
          else
            echo "run_this_minute=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Fetch Bingo (API, with pagination)
        if: steps.gate.outputs.run_this_minute == 'true'
        run: |
          echo "OPEN_DATE=${OPEN_DATE:-<auto>}"
          node --version
          mkdir -p data

          # 這是你 repo 裡的抓取腳本：scripts/fetch_bingo_api.mjs
          # 會處理分頁並輸出到 data/draws.json
          node scripts/fetch_bingo_api.mjs

          # 簡單校驗 JSON
          test -s data/draws.json
          head -c 2 data/draws.json | grep -q '\['

      - name: Commit & push if changed
        if: steps.gate.outputs.run_this_minute == 'true'
        run: |
          set -e
          if git diff --quiet -- data/draws.json; then
            echo "No changes in data/draws.json"
            exit 0
          fi

          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/draws.json
          git commit -m "chore(fetch): update draws.json ($(date -u +'%F %T') UTC)"
          git push origin HEAD:main